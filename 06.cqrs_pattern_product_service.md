# Sección 07: Patrón CQRS en product-service

---

## Acepta Body HTTP Request

Vamos a crear una clase que nos permitirá mapear los valores enviados en el body de la petición.

````java

@Data
public class CreateProductRestModel {
    private String title;
    private BigDecimal price;
    private Integer quantity;
}
````

Ahora en el `ProductController` modificamos el endpoint `createProduct()` para mapear los valores enviados en el cuerpo
de la solicitud a una clase java.

````java

@RequiredArgsConstructor
@RestController
@RequestMapping(path = "/api/v1/products")
public class ProductController {

    private final Environment environment;

    /* otro endpoint */

    @PostMapping
    public String createProduct(@RequestBody CreateProductRestModel request) {
        return "HTTP POST Handled " + request.getTitle();
    }

    /* otros endpoints */
}
````

Para probar si los valores que estamos enviando se están mapeando a la clase java, vamos a realizar una petición
levantando los servicios en este orden:

1. Discover Server
2. Product Service
3. Gateway Server

Finalmente, realizamos la petición y vemos que todo está funcionando correctamente.

````bash
$ curl -v -X POST -H "Content-Type: application/json" -d "{\"title\": \"Samsung 20\", \"price\": 3500.50, \"quantity\": 10}" http://localhost:8080/api/v1/products
>
* upload completely sent off: 57 bytes
< HTTP/1.1 200 OK
< Content-Type: text/plain;charset=UTF-8
< Content-Length: 28
< Date: Tue, 07 Jan 2025 21:13:13 GMT
<
HTTP POST Handled Samsung 20
````

## Agrega dependencia de Axon Framework al Product Service

Antes de continuar debemos agregar a nuestro `product-service` la dependencia de `Axon Framework`.

````xml
<!-- https://mvnrepository.com/artifact/org.axonframework/axon-spring-boot-starter -->
<dependency>
    <groupId>org.axonframework</groupId>
    <artifactId>axon-spring-boot-starter</artifactId>
    <version>4.10.3</version>
</dependency>
````

#### Nota: Actualización de Axon Framework a la versión 4.7.0 (En mi caso es la 4.10)

> Desde que publicó este curso en video, `Axon Framework` se ha actualizado a una versión más reciente. Lamentablemente,
> hay algunos cambios importantes.
>
> Abra el siguiente enlace en una nueva ventana del
> navegador: [Actualización a la versión 4.7](https://docs.axoniq.io/axon-framework-reference/4.10/upgrading-to-4-7/).
> Manténgalo abierto mientras crea las primeras clases de su aplicación. Esta página contiene información sobre todos
> los cambios importantes y cómo resolverlos.

## Crea una nueva clase de comando

Cuando se nombran comandos en `CQRS`, hay una convención de nomenclatura:

````
<Verb><Noun>Command
````

En nuestro caso crearemos la clase de comando llamada `CreateProductCommand`. Esta clase la crearemos en el paquete
`command`, dado que estamos siguiendo el patrón de diseño `CQRS` donde debemos mostrar una clara separación entre
la API de comandos y la API de consultas.

````java
package dev.magadiflo.app.command;

import lombok.Builder;
import lombok.Data;
import org.axonframework.modelling.command.TargetAggregateIdentifier;

import java.math.BigDecimal;

@Data
@Builder
public class CreateProductCommand {
    @TargetAggregateIdentifier
    private final String productId;
    private final String title;
    private final BigDecimal price;
    private final Integer quantity;
}
````

Notar que a todos los atributos de la clase anterior las hemos definido como `final` con la finalidad de hacer esta
clase como una clase de solo lectura.

Además, hemos agregado un atributo llamado `productId` a quien lo anotamos con `@TargetAggregateIdentifier`.
`Axon Framework` utilizará este identificador para asociar este comando con un objeto agregado. Un Agregado será nuestro
objeto de dominio y manejará comandos, validará el comando y decidirá si el nuevo producto puede ser creado o si el
evento necesita ser borrado.

Función de `@TargetAggregateIdentifier`:

- `Identificación del agregado objetivo`: Axon Framework utiliza esta anotación para determinar a qué agregado debe
  enviarse un comando. En términos simples, indica que el valor de este campo (`productId` en tu caso) se utilizará para
  identificar el agregado que manejará el comando.


- `Asociación con el agregado`: Cuando se maneja un comando, el marco necesita saber cuál instancia de un agregado
  específico debe procesarlo. El valor del campo marcado con esta anotación le proporciona al Axon Framework la clave
  para buscar el agregado correspondiente.

Contexto en tu clase `CreateProductCommand`:

- La clase define un comando (`CreateProductCommand`) que probablemente se envíe para crear un producto.
- El `productId`, marcado con `@TargetAggregateIdentifier`, asegura que `Axon Framework` sepa a cuál agregado de
  producto (`ProductAggregate`, por ejemplo) está destinado este comando.
- Esto es crucial en sistemas `CQRS` y `Event Sourcing`, donde los comandos se enrutan a agregados específicos para
  ejecutar acciones que alteran su estado.

## Crea un nuevo objeto de CreateProductCommand

Como ya tenemos creado nuestra clase `CreateProductCommand`, por ahora continuaremos creando un objeto de esta clase
almacenando los valores obtenidos del request.

````java

@RequiredArgsConstructor
@RestController
@RequestMapping(path = "/api/v1/products")
public class ProductController {

    private final Environment environment;

    /* other endpoint */

    @PostMapping
    public String createProduct(@RequestBody CreateProductRestModel request) {
        CreateProductCommand createProductCommand = CreateProductCommand.builder()
                .price(request.getPrice())
                .quantity(request.getQuantity())
                .title(request.getTitle())
                .productId(UUID.randomUUID().toString())
                .build();
        return "HTTP POST Handled " + request.getTitle();
    }

    /* other endpoints */
}
````