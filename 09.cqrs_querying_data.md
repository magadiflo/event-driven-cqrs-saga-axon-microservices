# Sección 09: CQRS. Consultando Datos

---

## Crea Rest Controller

Vamos a crear un nuevo controlador que será para realizar búsquedas, de esa manera, según el autor, mantendrá separada
tantos los `commands` como los `queries`.

Esta clase la crearemos en la siguiente dirección
`src/main/java/dev/magadiflo/app/query/rest/ProductQueryController.java`.

````java

@RestController
@RequestMapping(path = "/api/v1/products")
public class ProductQueryController {

}
````

## Crea endpoint del servicio web para obtener productos

El endpoint que crearemos retornará una lista de productos. Para eso, crearemos la clase `ProductRestModel`, que será
como nuestro `DTO`. Estas propiedades que contendrá nuestra clase las copiaremos de la clase `ProductCreatedEvent`,
por lo tanto, tendrá la misma información. La finalidad de crear una nueva clase es para tener bien definida la
responsabilidad de cada una.

````java

@Data
public class ProductRestModel {
    private String productId;
    private String title;
    private BigDecimal price;
    private Integer quantity;
}
````

Ahora sí creamos el endpoint que nos retornará una lista de `ProductRestModel`.

````java

@RestController
@RequestMapping(path = "/api/v1/products")
public class ProductQueryController {

    @GetMapping
    public ResponseEntity<List<ProductRestModel>> getProducts() {
        return null;
    }

}
````

## Realiza consulta con el QueryGateway

En este apartado crearemos y enviaremos una consulta al bus de consultas. El bus de consultas (query bus) enviará esta
consulta al gestor de consultas.

Empezaremos creando una clase `FindProductQuery`.

````java
public class FindProductQuery {
    // No hay atributos porque solo queremos obtener todos los productos
}
````

Si `FindProductQuery` solo se usa para recuperar todos los productos, no necesita tener atributos. Solo actúa como una
señal para que `Axon` maneje la consulta y devuelva los productos disponibles.

Cuando `Axon` reciba la consulta, llamará a un método que maneje `FindProductQuery` y devuelva la lista de productos.

`¿Cuándo FindProductQuery podría tener atributos?`, si necesitamos filtrar los productos (por categoría, precio, etc.)
podríamos agregar atributos. De esa manera, el manejador podría filtrar los productos según el valor del atributo
definido.

#### Conclusión

- `Sin atributos`, se usa para recuperar todos los productos.
- `Con atributos`, se usa si necesitas filtrar los productos con ciertos criterios.

A continuación se muestra el código del controlador que maneja solicitudes `HTTP` relacionadas con productos en una
aplicación basada en `Axon Framework`.

````java

@RequiredArgsConstructor
@RestController
@RequestMapping(path = "/api/v1/products")
public class ProductQueryController {

    private final QueryGateway queryGateway;

    @GetMapping
    public ResponseEntity<List<ProductRestModel>> getProducts() {
        FindProductQuery findProductQuery = new FindProductQuery();

        List<ProductRestModel> products = this.queryGateway
                .query(findProductQuery, ResponseTypes.multipleInstancesOf(ProductRestModel.class))
                .join();

        return ResponseEntity.ok(products);
    }

}
````

- `QueryGateway` es una interfaz de `Axon Framework` que permite enviar consultas y recibir respuestas. Se usa en el
  `CQRS(Command Query Responsibility Segregation)` para manejar consultas separadas de los comandos.


- `FindProductQuery` es una clase de consulta que se usa en `Axon Framework` para solicitar información sobre los
  productos. Normalmente, no tiene atributos si solo queremos recuperar todos los productos.


- El `queryGateway.query()` se usa para enviar la consulta `findProductQuery` al manejador de consultas de `Axon`.


- `ResponseTypes.multipleInstancesOf(ProductRestModel.class)`, se especifica que la respuesta será una lista de objetos
  `ProductRestModel`.


- `.join()`, bloquea la ejecución hasta que la consulta se resuelva y devuelve los resultados. Esto convierte la
  respuesta de un `CompletableFuture` en una lista de productos.

#### ¿Dónde está el manejador de la consulta?

El manejador de `FindProductQuery` debería estar en otro lugar del código, posiblemente en una clase anotada con
`@QueryHandler` en Axon.